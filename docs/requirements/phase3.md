# Phase 3：請求・承認フロー要件定義書

## 1. 背景と目的

### 背景
- Phase 1: 基本的な配送実績管理システム構築完了
- Phase 2: PDF生成とレポート機能、監視・セキュリティ基盤（v1.1.0）完了
- 現状課題: 物流の日報データから請求書への手作業連携に時間がかかっている

### 目的
- **手作業削減KPI**: Phase 2から更に-50%の工数削減を実現
- 配送実績データから請求書生成・承認・会計連携までの自動化
- 監査証跡の確保と権限分離による内部統制強化
- 取引先別の柔軟な料金計算とバッチ処理の効率化

## 2. スコープ

### 2.1 請求書生成機能
- **テンプレート管理**
  - 取引先別カスタマイズ可能な請求書フォーマット
  - ロゴ、住所、振込先情報の動的埋め込み
  - レイアウト変更履歴の管理
- **税務対応**
  - 消費税率設定（標準10%、軽減8%）
  - 適格請求書（インボイス制度）対応
  - 税区分別集計表示
- **締め日ルール**
  - 取引先別締め日設定（月末、20日締め等）
  - 自動集計期間算出
  - 祝日・営業日カレンダー連携

### 2.2 承認ワークフロー
- **承認ステップ**
  - 現場確認 → 管理者承認 → 経理承認の3段階
  - 条件分岐（金額閾値、取引先重要度による）
  - 並列承認・代理承認機能
- **差戻し・再申請**
  - コメント付き差戻し機能
  - 修正履歴の保持
  - 再申請時の変更点ハイライト

### 2.3 取引先マスタ・単価テーブル
- **複合計算式**
  - 距離単価（km × 単価）
  - 件数単価（配送件数 × 単価）
  - 固定費（車両費、保険料等）
  - 特殊料金（時間外、特急便等）
- **料金体系管理**
  - 有効期間設定
  - 改定履歴の保持
  - 一括更新・個別設定

### 2.4 明細CSV インポート/エクスポート
- **マッピング保存**
  - CSVカラムと項目の対応関係保存
  - 取引先別マッピングテンプレート
  - データ変換ルール設定
- **重複検出**
  - 配送日・取引先・金額での重複チェック
  - 手動確認・自動スキップ選択
  - エラーレポート出力

### 2.5 監査ログ・RBAC
- **役割定義**
  - Admin: 全機能アクセス、設定変更
  - Manager: 承認、レポート閲覧
  - Driver: 実績入力、自分の記録閲覧のみ
- **監査証跡**
  - 全データ変更履歴（Who, When, What, Why）
  - 承認・差戻しの理由記録
  - ログイン・操作履歴

### 2.6 通知機能
- **メール通知**
  - 承認依頼、差戻し通知
  - 締め日リマインダー
  - エラー・警告通知
- **Slack Webhook**
  - 重要なステータス変更通知
  - バッチ処理完了・エラー通知
  - 既存監視システム（v1.1.0）との連携

## 3. 非機能要件

### 3.1 パフォーマンス
- **請求書PDF生成**: p95 < 5秒（複雑なレイアウトでも）
- **バッチ処理**: 1,000件の請求書生成を30分以内
- **レスポンス**: 画面表示p95 < 2秒、API応答p95 < 1秒

### 3.2 可用性
- **稼働率**: 99%/30日以上（既存システムと同等）
- **SLOバーンレート**: 既存アラート（ExpiredSignedUrlRateWarn/Crit）に準拠
- **バックアップ**: 日次自動バックアップ、RPO 24時間、RTO 2時間

### 3.3 セキュリティ
- **PIIマスキング**: 個人情報の画面表示・ログ出力時マスキング
- **権限分離**: 職務分離の徹底（入力者≠承認者）
- **監査証跡保持**: 90日以上の詳細ログ保持
- **既存セキュリティ基盤**: helmet、rate-limit、Sentry連携（v1.1.0）を継承

## 4. 画面/フロー

### 4.1 主要画面ワイヤフレーム（概要）

#### 請求一覧画面
```
[フィルタ] [検索] [新規作成] [一括操作]
┌─────────────────────────────────────────┐
│取引先 │ 請求月 │ 金額    │ 状態     │操作│
├─────────────────────────────────────────┤
│ABC運輸│ 2024-01│ ¥125,000│ 承認済み │詳細│
│DEF商事│ 2024-01│ ¥89,500 │ 承認待ち │詳細│
└─────────────────────────────────────────┘
```

#### 明細取込画面
```
[ファイル選択] [マッピング選択] [プレビュー] [取込実行]
┌─────────────────────────────────────────┐
│CSVカラム │ → │ システム項目                │
├─────────────────────────────────────────┤
│配送日    │ → │ delivery_date              │
│取引先名  │ → │ customer_name              │
│金額      │ → │ amount                     │
└─────────────────────────────────────────┘
```

#### 承認キュー画面
```
[承認待ち] [差戻し済] [完了済] タブ
┌─────────────────────────────────────────┐
│申請者  │ 取引先 │ 金額    │ 申請日 │操作  │
├─────────────────────────────────────────┤
│田中太郎│ABC運輸 │¥125,000│01-25  │承認  │
│佐藤花子│DEF商事 │¥89,500 │01-24  │詳細  │
└─────────────────────────────────────────┘
```

#### 取引先設定画面
```
[基本情報] [料金設定] [承認ルール] タブ
┌─────────────────────────────────────────┐
│料金体系: [距離単価] [件数単価] [固定費]    │
│距離単価: [100]円/km  有効期間:[2024-01～] │
│件数単価: [500]円/件                      │
│固定費  : [10,000]円/月                   │
└─────────────────────────────────────────┘
```

### 4.2 状態遷移図
```
Draft → Submitted → Approved → Invoiced → Paid
  ↓        ↓          ↓         ↓        ↓
  └─ 編集可能  └─ 承認待ち  └─ 請求済み └─ 入金済み
                ↓
             Rejected
                ↓
           再申請可能
```

## 5. 外部連携

### 5.1 会計SaaS連携（将来実装）
- **対象**: freee、マネーフォワード会計
- **連携方式**: REST API（OAuth 2.0認証）
- **疎結合設計**: アダプターパターンで実装し、SaaS変更に柔軟対応
- **連携データ**: 請求書データ、入金管理、仕訳データ

### 5.2 API下見
- freee API: `/invoices`、`/payments` エンドポイント調査済み
- マネーフォワード API: Webhook受信による入金通知対応予定
- 認証トークン管理: 暗号化保存、自動リフレッシュ機能

## 6. テレメトリ/監視

### 6.1 新規メトリクス
```yaml
# Prometheusメトリクス定義
invoice_requests_total:
  type: Counter
  labels: [operation, status, customer_type]
  description: "請求関連操作の総数"

invoice_duration_seconds:
  type: Histogram
  buckets: [0.5, 1, 2, 5, 10, 30]
  description: "請求書生成処理時間"

approval_events_total:
  type: Counter
  labels: [action, role, amount_tier]
  description: "承認フロー関連イベント数"

batch_processing_duration_seconds:
  type: Histogram
  labels: [batch_type]
  description: "バッチ処理実行時間"
```

### 6.2 既存Runbook追記ポイント
- `docs/observability/runbooks/pdf.md` への以下セクション追加:
  - 「請求書PDF生成エラー」対応手順
  - 「バッチ処理遅延」対応手順
  - 「承認フロー停滞」対応手順
- アラート定義追加: `InvoicePDFGenerationSlow`, `ApprovalQueueBacklog`

## 7. 検証計画

### 7.1 E2E テスト（Cypress）
**シナリオ**: 取込→集計→承認→PDF→保存→再署名
```typescript
// cypress/e2e/invoice_flow.cy.ts
describe('Invoice Full Flow', () => {
  it('should complete full invoice workflow', () => {
    // 1. CSV取込
    cy.visit('/invoices/import')
    cy.uploadFile('sample_delivery_data.csv')
    cy.selectMapping('template_abc_transport')
    cy.click('[data-cy=import-execute]')
    
    // 2. 集計確認
    cy.visit('/invoices')
    cy.contains('ABC運輸').click()
    cy.get('[data-cy=total-amount]').should('contain', '¥125,000')
    
    // 3. 承認申請
    cy.click('[data-cy=submit-approval]')
    cy.get('[data-cy=status]').should('contain', '承認待ち')
    
    // 4. PDF生成・保存
    cy.switchUser('manager')
    cy.visit('/approvals')
    cy.click('[data-cy=approve-button]')
    cy.wait('@pdfGeneration').then((xhr) => {
      expect(xhr.response.body.success).to.be.true
    })
    
    // 5. 再署名テスト
    cy.wait(2000) // URL期限切れシミュレート
    cy.refreshSignedUrl()
    cy.verifyPdfAccess()
  })
})
```

### 7.2 スモークテスト拡張
**既存smoke.shの請求テンプレート対応**:
```bash
# scripts/post-release-smoke.sh 拡張
MODE=save TYPE=invoice BYTES_MIN=2048 TIMEOUT=45 \
./scripts/post-release-smoke.sh

# 請求書PDFの最小サイズチェック（2KB以上）
# テンプレートの複雑さを考慮した閾値設定
```

## 8. マイルストーン/ロードマップ

### M1: 請求PDFと単価テーブル（2週間）
**成果物**:
- 請求書PDFテンプレートエンジン
- 取引先マスタ・単価テーブル管理画面
- 基本的な料金計算ロジック
- 単体テスト・統合テスト

**完了条件**:
- 3パターンの請求書レイアウト作成完了
- 複合料金計算（距離+件数+固定費）動作確認
- PDF生成p95 < 5秒達成

### M2: 承認フロー・監査ログ（2週間）
**成果物**:
- ワークフロー状態管理
- 承認・差戻し機能
- RBAC実装
- 監査ログ記録・検索機能

**完了条件**:
- 3段階承認フロー完全動作
- 権限分離テスト完了
- 監査ログ90日保持設定完了

### M3: インポート/エクスポート・通知（2週間）
**成果物**:
- CSV取込・エクスポート機能
- マッピング保存・重複検出
- メール・Slack通知機能
- E2Eテスト完成

**完了条件**:
- 大量データ（1,000件）取込テスト完了
- 通知機能統合テスト完了
- 本番リリース準備完了

## 9. 既存システム前提（v1.1.0継承）

### 9.1 監視・アラート基盤
- Prometheus + Grafana ダッシュボード継続使用
- SLOバーンレート監視（99%可用性前提）継続
- Slack通知チャンネル統合

### 9.2 セキュリティ基盤
- helmet、express-rate-limit セキュリティミドルウェア継続
- Sentry エラートラッキング継続
- リクエストID伝播・構造化ログ継続

### 9.3 インフラストラクチャ
- Kubernetes デプロイメント継続（ops/k8s/deploy.yaml拡張）
- GitHub Actions CI/CD継続（smoke testing拡張）
- Docker コンテナベース継続

### 9.4 API設計原則
- RESTful API設計継続
- OpenAPI仕様書管理継続
- バージョニング戦略継続

---

**備考**: 本要件定義書は初稿であり、実装過程で詳細仕様の調整・追加が予想される。重要な変更点は本文書への反映とステークホルダーへの共有を行う。